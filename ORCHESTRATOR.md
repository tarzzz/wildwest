# Orchestrator Architecture

## Overview

The Project Manager now functions as an **active orchestrator** that manages the entire lifecycle of Claude Code instances. Personas can dynamically request new team members by creating directories, and the orchestrator spawns actual Claude processes.

## Key Changes from Original Design

### Old Model (Static)
- All personas spawned upfront by `team start`
- Fixed team size
- Project Manager was read-only tracker

### New Model (Dynamic)
- Manager and Architect spawned initially
- Engineers and Interns requested dynamically
- Project Manager actively manages Claude instances
- Team grows organically as needed

## Workflow

### 1. Start a Team

```bash
# Create workspace and initial structure
claude-wrapper team start "Build REST API"

# This creates:
# - engineering-manager-{timestamp}/
# - solutions-architect-{timestamp}/
# - Optional: initial engineers/interns if --engineers/--interns specified
```

### 2. Start the Orchestrator

```bash
# In a separate terminal
claude-wrapper orchestrate --workspace .database

# The orchestrator:
# - Spawns Claude for Manager and Architect
# - Watches for spawn requests (*-request-* directories)
# - Monitors running sessions
# - Terminates completed sessions
```

### 3. Dynamic Team Growth

#### Manager/Architect Requests an Engineer

```bash
# From within their Claude session:
mkdir .database/software-engineer-request-api-developer
cat > .database/software-engineer-request-api-developer/instructions.md <<EOF
Implement REST API endpoints for user CRUD operations.
Follow the architecture in shared/api-spec.md.
EOF

# Orchestrator detects the request directory
# Creates software-engineer-{timestamp}/
# Spawns Claude instance
# Removes request directory
```

#### Engineer Requests an Intern

```bash
# From within their Claude session:
mkdir .database/intern-request-test-writer
cat > .database/intern-request-test-writer/instructions.md <<EOF
Write unit tests for user_handler.go
Ensure >80% coverage
Fix any linting issues
EOF

# Orchestrator spawns intern Claude instance
```

### 4. Monitor and Attach

```bash
# List all running instances
claude-wrapper attach --list

# Attach to manager (default)
claude-wrapper attach

# Attach to specific session
claude-wrapper attach software-engineer-1234567890

# Filter by type
claude-wrapper attach --filter engineer --list
```

### 5. Automatic Cleanup

When all tasks in a persona's `tasks.md` are marked "completed":
- Orchestrator detects completion
- Terminates the Claude process
- Archives the directory to `{session-id}-completed`

## Directory Structure

### Request Directories

Created by personas to request new team members:

```
.database/
â”œâ”€â”€ software-engineer-request-{name}/
â”‚   â””â”€â”€ instructions.md         # Initial instructions for this engineer
â””â”€â”€ intern-request-{name}/
    â””â”€â”€ instructions.md         # Initial instructions for this intern
```

### Active Session Directories

Created by orchestrator after spawning:

```
.database/
â”œâ”€â”€ engineering-manager-1234567890/
â”‚   â”œâ”€â”€ session.json
â”‚   â”œâ”€â”€ tasks.md
â”‚   â”œâ”€â”€ instructions.md
â”‚   â”œâ”€â”€ tracker.json
â”‚   â””â”€â”€ persona-instructions.md  # Generated by orchestrator
â”œâ”€â”€ software-engineer-1234567891/
â””â”€â”€ intern-1234567892/
```

### Completed Session Directories

Archived by orchestrator:

```
.database/
â””â”€â”€ software-engineer-1234567891-completed/
    â””â”€â”€ (all files preserved)
```

## Orchestrator Functions

### Spawn Detection

Scans every 5 seconds for:
1. `*-request-*` directories (new spawn requests)
2. Existing session directories without running processes
3. Initial manager/architect sessions

### Process Management

```go
runningProcs map[string]*exec.Cmd
// sessionID -> Claude process
```

Tracks:
- Process ID (PID)
- Start time
- Exit status

### Completion Detection

Monitors `tasks.md` files:
- Parses task statuses
- Checks if all tasks are "completed"
- Terminates process when done
- Archives directory

### Lifecycle Events

```
Request â†’ Create Session â†’ Spawn Claude â†’ Monitor â†’ Complete â†’ Archive
```

## Communication Protocol

### Requesting Team Members

#### From Manager/Architect â†’ Request Engineer

```bash
# Create request directory
mkdir .database/software-engineer-request-frontend-dev

# Write initial instructions
cat > .database/software-engineer-request-frontend-dev/instructions.md <<EOF
## Instructions from solutions-architect-1234567890 (2024-01-26 15:00:00)

Implement the React frontend for the user dashboard.

Requirements:
- Use React hooks
- Follow component structure in shared/frontend-architecture.md
- Implement authentication flow
- Add comprehensive tests

Deliverables:
- src/components/Dashboard.tsx
- src/components/UserProfile.tsx
- tests/
EOF
```

#### From Engineer â†’ Request Intern

```bash
# Create request directory
mkdir .database/intern-request-unit-tester

# Write initial instructions
cat > .database/intern-request-unit-tester/instructions.md <<EOF
## Instructions from software-engineer-1234567891 (2024-01-26 16:00:00)

Write unit tests for all functions in user_service.go

Requirements:
- Use testify/assert
- Achieve >80% coverage
- Test edge cases
- Fix any linting errors

Run: go test -cover
EOF
```

### What the Orchestrator Does

1. **Detects** request directory
2. **Creates** new session with unique ID
3. **Copies** instructions.md from request to new session
4. **Generates** persona-specific instructions
5. **Spawns** Claude Code process
6. **Removes** request directory
7. **Tracks** process PID

### Claude Instance Spawning

```bash
# Command executed by orchestrator:
claude \
  --instructions .database/{session-id}/persona-instructions.md \
  "Start working on your assigned tasks"
```

The `persona-instructions.md` includes:
- Base persona instructions
- Session information
- Directory structure guide
- How to request more team members
- Task completion guidelines

## Attaching to Sessions

### List All Sessions

```bash
$ claude-wrapper attach --list

Available Sessions:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ENGINEERING MANAGER
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”„ manager
   Session ID: engineering-manager-1234567890
   Status: active
   Started: 2024-01-26 15:00:00
   PID: 12345

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  SOFTWARE ENGINEERS
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”„ frontend-dev
   Session ID: software-engineer-1234567891
   Status: active
   Started: 2024-01-26 15:05:00
   PID: 12346
```

### Attach to Manager (Default)

```bash
$ claude-wrapper attach

ğŸ”— Attaching to session: engineering-manager-1234567890
   Directory: .database/engineering-manager-1234567890

You are now in the session's directory.
Available files:
  - tasks.md: View/edit task list
  - instructions.md: View instructions
  - tracker.json: View reading state

# Now in interactive shell at session directory
$ ls
tasks.md  instructions.md  tracker.json  session.json  project-requirements.md

$ cat tasks.md
# Tasks

## Task: Build REST API
- **Status**: in progress
...

$ exit  # Returns to main shell
```

### Attach to Specific Session

```bash
# By session ID
claude-wrapper attach software-engineer-1234567891

# By filter
claude-wrapper attach --filter frontend-dev --list
```

## Complete Example Workflow

### Initial Setup

```bash
# Terminal 1: Start team
cd /Users/tarun/plotly/agents
./bin/claude-wrapper team start "Build blog platform with posts and comments"

# Terminal 2: Start orchestrator
./bin/claude-wrapper orchestrate --workspace .database
```

Output:
```
ğŸ¯ Project Manager Orchestrator Started
   Workspace: .database
   Poll Interval: 5s

ğŸš€ Spawning engineering-manager: manager
   âœ… Session: engineering-manager-1706012345678 (PID: 12345)

ğŸš€ Spawning solutions-architect: architect
   âœ… Session: solutions-architect-1706012345679 (PID: 12346)
```

### Manager Requests Engineer

Manager's Claude session creates:
```bash
mkdir .database/software-engineer-request-backend-api
cat > .database/software-engineer-request-backend-api/instructions.md <<EOF
Implement backend API for blog platform
EOF
```

Orchestrator detects and spawns:
```
ğŸš€ Spawning software-engineer: backend-api
   âœ… Session: software-engineer-1706012345680 (PID: 12347)
```

### Engineer Requests Intern

Engineer's Claude session creates:
```bash
mkdir .database/intern-request-api-tester
cat > .database/intern-request-api-tester/instructions.md <<EOF
Write integration tests for blog API endpoints
EOF
```

Orchestrator spawns:
```
ğŸš€ Spawning intern: api-tester
   âœ… Session: intern-1706012345681 (PID: 12348)
```

### Monitor from Terminal 3

```bash
# List sessions
./bin/claude-wrapper attach --list

# Attach to engineer
./bin/claude-wrapper attach software-engineer-1706012345680

# Inside the session, check progress
$ cat tasks.md
## Task: Implement backend API
- **Status**: in progress

$ ls *.go
blog_handler.go  post_handler.go  comment_handler.go

$ exit
```

### Completion and Cleanup

When engineer marks all tasks complete:

```markdown
## Task: Implement backend API
- **Status**: completed
```

Orchestrator detects:
```
ğŸ‰ All tasks completed for backend-api (software-engineer-1706012345680)
   ğŸ“¦ Archived to: software-engineer-1706012345680-completed
```

## Benefits

1. **Dynamic Scaling**: Team grows as needed
2. **Resource Efficient**: Only run Claude for active work
3. **Automatic Cleanup**: Completed sessions archived
4. **Interactive**: Attach to any session anytime
5. **Organic Growth**: Natural team formation
6. **Cost Effective**: Don't spawn unnecessary instances
7. **Self-Managing**: Orchestrator handles lifecycle

## Commands Summary

```bash
# Setup
claude-wrapper team start "task" [--engineers N] [--interns N]

# Orchestration (run in separate terminal)
claude-wrapper orchestrate --workspace .database

# Monitoring
claude-wrapper attach --list                    # List all sessions
claude-wrapper attach                           # Attach to manager
claude-wrapper attach <session-id>             # Attach to specific
claude-wrapper attach --filter engineer --list  # Filter by type
claude-wrapper track                            # Status dashboard

# Traditional (still works)
claude-wrapper team status                      # Check status
claude-wrapper team stop                        # Stop all
```

## Directory Naming Conventions

### Request Patterns
- `software-engineer-request-{descriptive-name}/`
- `intern-request-{descriptive-name}/`

### Active Sessions
- `engineering-manager-{timestamp}/`
- `solutions-architect-{timestamp}/`
- `software-engineer-{timestamp}/`
- `intern-{timestamp}/`

### Completed Sessions
- `{original-name}-completed/`

## Orchestrator Monitoring

The orchestrator outputs real-time events:

```
ğŸš€ Spawning software-engineer: api-developer
   âœ… Session: software-engineer-1706012345680 (PID: 12347)

âš ï¸  Process for intern-1706012345681 has exited

ğŸ‰ All tasks completed for api-developer (software-engineer-1706012345680)
   ğŸ“¦ Archived to: software-engineer-1706012345680-completed

âœ… Session software-engineer-1706012345680 completed successfully
```

## Best Practices

1. **Always run orchestrator**: Required for spawning
2. **Use descriptive names**: When creating requests
3. **Monitor regularly**: Use `attach --list`
4. **Complete tasks**: Mark done to trigger cleanup
5. **One orchestrator**: Only run one per workspace
6. **Terminal per orchestrator**: Dedicated terminal for logs
